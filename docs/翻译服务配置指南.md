# 翻译服务配置指南

本文档提供了多种翻译服务的配置教程，你可以根据需求选择合适的翻译服务提供商。

## 目录
- [Azure Translator（推荐 - 国际版）](#1-azure-translator推荐---国际版)
- [百度翻译（推荐 - 国内版）](#2-百度翻译推荐---国内版)
- [腾讯云机器翻译](#3-腾讯云机器翻译)
- [阿里云机器翻译](#4-阿里云机器翻译)
- [Google Translate API](#5-google-translate-api)
- [DeepL API](#6-deepl-api)
- [服务对比](#服务对比)

---

## 1. Azure Translator（推荐 - 国际版）

### 优势
- ✅ 免费额度大（每月 200 万字符）
- ✅ 国内可用，无需 VPN
- ✅ 支持语言多（100+ 种语言）
- ✅ 稳定可靠，微软官方服务
- ✅ **当前系统默认使用**

### 免费额度
- **每月 200 万字符** 完全免费
- 超出后按 $10/百万字符 计费

### 申请步骤

#### 步骤 1: 创建 Azure 账号
1. 访问 [Azure 官网](https://portal.azure.com/)
2. 点击右上角 **"免费开始使用"** 或 **"Sign in"**
3. 使用 Microsoft 账号登录（没有则注册一个）
4. 首次使用会要求绑定信用卡（用于身份验证，免费额度内不会扣费）

#### 步骤 2: 创建 Translator 资源
1. 登录 [Azure Portal](https://portal.azure.com/)
2. 点击左上角 **"创建资源"** 或搜索 **"Translator"**
3. 在市场中搜索 **"Translator"**，选择 **"Translator"**
4. 点击 **"创建"**

#### 步骤 3: 配置资源
填写以下信息：
- **订阅**: 选择你的订阅（一般是 "Pay-As-You-Go" 或 "免费试用"）
- **资源组**: 创建新资源组，命名如 `translator-rg`
- **区域**: 选择 **East US**（或其他区域，建议选择离你近的）
- **名称**: 自定义名称，如 `my-translator`
- **定价层**: 选择 **F0 (Free)** - 每月 200 万字符免费

点击 **"查看 + 创建"** → **"创建"**

#### 步骤 4: 获取 API 密钥
1. 资源创建完成后，点击 **"转到资源"**
2. 在左侧菜单中选择 **"密钥和终结点"** (Keys and Endpoint)
3. 你会看到：
   - **KEY 1** 和 **KEY 2**（两个密钥，任选一个）
   - **位置/区域** (Location/Region)：如 `eastus`
   - **终结点** (Endpoint)：如 `https://api.cognitive.microsofttranslator.com/`

#### 步骤 5: 配置到项目
打开 `backend/.env` 文件，添加/修改：

```bash
# Azure Translator 配置
AZURE_TRANSLATOR_KEY=你的_KEY_1_或_KEY_2
AZURE_TRANSLATOR_REGION=eastus
AZURE_TRANSLATOR_ENDPOINT=https://api.cognitive.microsofttranslator.com
```

#### 步骤 6: 重启服务
```bash
# 在 backend 目录下
pnpm dev
```

#### 验证配置
访问翻译服务状态接口：
```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  http://localhost:3000/api/v1/translation/status
```

响应示例：
```json
{
  "success": true,
  "data": {
    "available": true,
    "provider": "Microsoft Azure Translator"
  }
}
```

---

## 2. 百度翻译（推荐 - 国内版）

### 优势
- ✅ 国内服务，速度快
- ✅ 免费额度大（每月 200 万字符）
- ✅ 价格便宜（超出后 $6/百万字符）
- ✅ 中文翻译质量好
- ✅ 无需外币信用卡

### 免费额度
- **每月 200 万字符** 完全免费
- 超出后按 ¥49/百万字符 计费

### 申请步骤

#### 步骤 1: 注册百度账号
1. 访问 [百度翻译开放平台](https://fanyi-api.baidu.com/)
2. 点击右上角 **"登录"**，使用百度账号登录（没有则注册）
3. 登录后点击 **"管理控制台"**

#### 步骤 2: 进行开发者认证
1. 首次使用需要进行 **开发者认证**
2. 点击 **"个人信息"** → **"开发者认证"**
3. 填写个人信息（姓名、身份证号）或企业信息
4. 等待审核（一般 1-2 个工作日，个人认证可能当天通过）

#### 步骤 3: 创建应用
1. 认证通过后，进入 **"管理控制台"**
2. 点击 **"通用翻译API"** → **"立即使用"**
3. 点击 **"开通服务"**
4. 选择 **"通用文本翻译"**，点击 **"下一步"**
5. 填写应用信息：
   - **应用名称**: 如 `KOL BD Tool`
   - **应用类型**: 选择 **"API"**
   - **选择服务**: 勾选 **"通用文本翻译"**
6. 点击 **"提交申请"**

#### 步骤 4: 获取 APP ID 和密钥
1. 应用创建成功后，在 **"开发者信息"** 页面可以看到：
   - **APP ID**: 一串数字
   - **密钥 (Secret Key)**: 一串字母数字组合

#### 步骤 5: 修改代码（需要替换翻译服务）
> ⚠️ **注意**：百度翻译需要修改 `translation.service.ts`，因为 API 接口不同于 Azure

打开 `backend/src/features/translation/translation.service.ts`，替换为百度翻译实现：

```typescript
/**
 * 翻译服务 - 百度翻译版本
 */

import crypto from 'crypto';
import axios from 'axios';
import { logger } from '@config/logger.config';

class TranslationService {
  private appId: string;
  private secretKey: string;
  private endpoint: string = 'https://fanyi-api.baidu.com/api/trans/vip/translate';

  constructor() {
    this.appId = process.env.BAIDU_TRANSLATE_APP_ID || '';
    this.secretKey = process.env.BAIDU_TRANSLATE_SECRET_KEY || '';

    if (this.appId && this.secretKey) {
      logger.info('百度翻译客户端初始化成功');
    } else {
      logger.warn('百度翻译 API 密钥未配置，翻译功能将不可用');
    }
  }

  /**
   * 生成签名
   */
  private generateSign(query: string, salt: string): string {
    const str = this.appId + query + salt + this.secretKey;
    return crypto.createHash('md5').update(str).digest('hex');
  }

  /**
   * 语言代码转换（系统 -> 百度）
   */
  private convertLanguageCode(code: string): string {
    const mapping: Record<string, string> = {
      'en': 'en',
      'zh': 'zh',
      'ja': 'jp',
      'ko': 'kor',
      'es': 'spa',
      'fr': 'fra',
      'de': 'de',
      'ru': 'ru',
      'pt': 'pt',
    };
    return mapping[code] || code;
  }

  /**
   * 翻译文本
   */
  async translate(
    text: string,
    targetLanguage: string,
    sourceLanguage?: string
  ): Promise<string> {
    if (!this.appId || !this.secretKey) {
      throw new Error('翻译服务未配置，请联系管理员配置百度翻译 API 密钥');
    }

    if (!text || text.trim() === '') {
      return text;
    }

    try {
      logger.info(`开始翻译: ${sourceLanguage || 'auto'} -> ${targetLanguage}, 文本长度: ${text.length}`);

      const salt = Date.now().toString();
      const sign = this.generateSign(text, salt);

      const params = {
        q: text,
        from: sourceLanguage ? this.convertLanguageCode(sourceLanguage) : 'auto',
        to: this.convertLanguageCode(targetLanguage),
        appid: this.appId,
        salt,
        sign,
      };

      const response = await axios.get(this.endpoint, { params });

      if (response.data.error_code) {
        logger.error('百度翻译请求失败:', response.data);
        throw new Error(`翻译失败: ${response.data.error_msg}`);
      }

      const translatedText = response.data.trans_result
        .map((item: any) => item.dst)
        .join('\n');

      logger.info(`翻译成功: 源文本长度 ${text.length} -> 译文长度 ${translatedText.length}`);

      return translatedText;
    } catch (error: any) {
      logger.error('翻译失败:', error);
      throw new Error(`翻译失败: ${error.message}`);
    }
  }

  /**
   * 批量翻译
   */
  async batchTranslate(
    texts: string[],
    targetLanguage: string,
    sourceLanguage?: string
  ): Promise<string[]> {
    if (texts.length === 0) {
      return [];
    }

    try {
      logger.info(`开始批量翻译: ${texts.length} 条文本`);

      const results = await Promise.all(
        texts.map(text => this.translate(text, targetLanguage, sourceLanguage))
      );

      logger.info(`批量翻译成功: ${results.length} 条文本`);
      return results;
    } catch (error: any) {
      logger.error('批量翻译失败:', error);
      throw new Error(`批量翻译失败: ${error.message}`);
    }
  }

  /**
   * 检测语言（百度翻译不直接支持，使用 auto 翻译后检测）
   */
  async detectLanguage(text: string): Promise<{ language: string; score: number }> {
    if (!this.appId || !this.secretKey) {
      throw new Error('翻译服务未配置');
    }

    try {
      logger.info(`开始检测语言: 文本长度 ${text.length}`);

      const salt = Date.now().toString();
      const sign = this.generateSign(text, salt);

      const params = {
        q: text,
        from: 'auto',
        to: 'zh',
        appid: this.appId,
        salt,
        sign,
      };

      const response = await axios.get(this.endpoint, { params });

      if (response.data.error_code) {
        throw new Error(`语言检测失败: ${response.data.error_msg}`);
      }

      // 百度翻译会在 from 字段返回检测到的语言
      const detectedLang = response.data.from || 'auto';

      logger.info(`语言检测成功: ${detectedLang}`);

      return {
        language: detectedLang,
        score: 1.0, // 百度不提供置信度，默认 1.0
      };
    } catch (error: any) {
      logger.error('语言检测失败:', error);
      throw new Error(`语言检测失败: ${error.message}`);
    }
  }

  /**
   * 检查翻译服务是否可用
   */
  isAvailable(): boolean {
    return !!(this.appId && this.secretKey);
  }
}

// 导出单例
export const translationService = new TranslationService();
```

#### 步骤 6: 配置环境变量
打开 `backend/.env` 文件，替换 Azure 配置为百度翻译配置：

```bash
# 百度翻译配置
BAIDU_TRANSLATE_APP_ID=你的_APP_ID
BAIDU_TRANSLATE_SECRET_KEY=你的_SECRET_KEY
```

同时更新 `backend/.env.example`：

```bash
# 翻译服务配置 (百度翻译)
# 申请地址: https://fanyi-api.baidu.com/
# 免费额度: 每月 200 万字符
# 获取密钥: 开发者中心 -> 开发者信息
BAIDU_TRANSLATE_APP_ID=your-app-id-here
BAIDU_TRANSLATE_SECRET_KEY=your-secret-key-here
```

#### 步骤 7: 安装依赖（如果需要）
```bash
cd backend
pnpm add axios  # 可能已经安装
```

#### 步骤 8: 重启服务
```bash
pnpm dev
```

---

## 3. 腾讯云机器翻译

### 优势
- ✅ 国内服务，速度快
- ✅ 免费额度超大（每月 500 万字符）
- ✅ 价格最便宜（超出后 ¥58/千万字符 = $0.80/百万字符）
- ✅ 腾讯云生态集成

### 免费额度
- **每月 500 万字符** 完全免费（最大）
- 超出后按 ¥58/千万字符 计费

### 申请步骤

#### 步骤 1: 注册腾讯云账号
1. 访问 [腾讯云官网](https://cloud.tencent.com/)
2. 点击右上角 **"免费注册"**
3. 完成实名认证（个人或企业）

#### 步骤 2: 开通机器翻译服务
1. 登录 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 搜索 **"机器翻译"** 或访问 [机器翻译产品页](https://console.cloud.tencent.com/tmt)
3. 点击 **"立即使用"**
4. 开通服务（首次开通会自动激活免费额度）

#### 步骤 3: 创建 API 密钥
1. 访问 [访问管理 - API 密钥](https://console.cloud.tencent.com/cam/capi)
2. 点击 **"新建密钥"**
3. 记录：
   - **SecretId**: 类似 `AKIDxxxxxxxxxxxxxxxx`
   - **SecretKey**: 类似 `xxxxxxxxxxxxxxxx`

⚠️ **重要**：密钥只显示一次，请妥善保存

#### 步骤 4: 修改代码（需要替换翻译服务）
创建腾讯云翻译实现，或告诉我，我帮你实现。

#### 步骤 5: 配置环境变量
```bash
# 腾讯云机器翻译配置
TENCENT_TRANSLATE_SECRET_ID=你的_SECRET_ID
TENCENT_TRANSLATE_SECRET_KEY=你的_SECRET_KEY
TENCENT_TRANSLATE_REGION=ap-guangzhou  # 或 ap-beijing, ap-shanghai
```

---

## 4. 阿里云机器翻译

### 优势
- ✅ 国内服务
- ✅ 阿里云生态
- ✅ 免费额度：每月 100 万字符
- ✅ 支持专业领域翻译

### 免费额度
- **每月 100 万字符** 完全免费
- 超出后按 ¥50/百万字符 计费

### 申请步骤

#### 步骤 1: 注册阿里云账号
1. 访问 [阿里云官网](https://www.aliyun.com/)
2. 注册并完成实名认证

#### 步骤 2: 开通机器翻译服务
1. 访问 [机器翻译产品页](https://www.aliyun.com/product/ai/alimt)
2. 点击 **"立即开通"**
3. 选择 **"通用版"**（免费额度）

#### 步骤 3: 创建 AccessKey
1. 访问 [AccessKey 管理](https://ram.console.aliyun.com/manage/ak)
2. 点击 **"创建 AccessKey"**
3. 记录：
   - **AccessKey ID**
   - **AccessKey Secret**

#### 步骤 4: 配置环境变量
```bash
# 阿里云机器翻译配置
ALIYUN_TRANSLATE_ACCESS_KEY_ID=你的_ACCESS_KEY_ID
ALIYUN_TRANSLATE_ACCESS_KEY_SECRET=你的_ACCESS_KEY_SECRET
ALIYUN_TRANSLATE_REGION=cn-hangzhou
```

---

## 5. Google Translate API

### 优势
- ✅ 翻译质量好
- ✅ 支持 130+ 种语言
- ✅ Google 官方服务

### 劣势
- ❌ 国内需要 VPN
- ❌ 免费额度较少（每月 50 万字符）
- ❌ 需要外币信用卡

### 免费额度
- **每月 50 万字符** 完全免费
- 超出后按 $20/百万字符 计费

### 申请步骤

#### 步骤 1: 创建 Google Cloud 账号
1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 使用 Google 账号登录
3. 首次使用会要求绑定信用卡（用于身份验证）

#### 步骤 2: 创建项目
1. 在控制台点击项目下拉菜单
2. 点击 **"新建项目"**
3. 输入项目名称，如 `KOL-BD-Tool`
4. 点击 **"创建"**

#### 步骤 3: 启用 Translation API
1. 在搜索框搜索 **"Cloud Translation API"**
2. 点击进入 API 页面
3. 点击 **"启用"**

#### 步骤 4: 创建 API 密钥
1. 进入 **"凭据"** 页面
2. 点击 **"创建凭据"** → **"API 密钥"**
3. 复制生成的 API 密钥

⚠️ **建议**：限制 API 密钥只能访问 Translation API

#### 步骤 5: 配置环境变量
```bash
# Google Translate 配置
GOOGLE_TRANSLATE_API_KEY=你的_API_KEY
```

---

## 6. DeepL API

### 优势
- ✅ 翻译质量最好（尤其是欧洲语言）
- ✅ 自然流畅
- ✅ 支持文档翻译

### 劣势
- ❌ 支持语言较少（30+ 种）
- ❌ 国内可能需要 VPN
- ❌ 免费额度较少

### 免费额度
- **每月 50 万字符** 完全免费
- 超出后按 $5/百万字符 计费（DeepL API Free 版本）
- Pro 版本：$25/百万字符（但质量更高）

### 申请步骤

#### 步骤 1: 注册 DeepL 账号
1. 访问 [DeepL API](https://www.deepl.com/pro-api)
2. 点击 **"Sign up for free"**
3. 填写邮箱、密码，完成注册

#### 步骤 2: 选择计划
1. 登录后进入 [Account 页面](https://www.deepl.com/account/summary)
2. 选择 **"DeepL API Free"** 计划
3. 需要绑定信用卡（免费额度内不会扣费）

#### 步骤 3: 获取 API 密钥
1. 进入 [API Keys 页面](https://www.deepl.com/account/usage)
2. 在 **"Authentication Key for DeepL API"** 下方可以看到你的 API Key
3. 复制密钥

#### 步骤 4: 配置环境变量
```bash
# DeepL 配置
DEEPL_API_KEY=你的_API_KEY
DEEPL_API_ENDPOINT=https://api-free.deepl.com  # Free 版本
# DEEPL_API_ENDPOINT=https://api.deepl.com     # Pro 版本
```

---

## 服务对比

| 服务商 | 免费额度 | 超出后价格 | 支持语言 | 国内访问 | 翻译质量 | 推荐度 |
|--------|----------|------------|----------|----------|----------|--------|
| **Azure Translator** | 200万字符/月 | $10/百万字符 | 100+ | ✅ 无需VPN | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **百度翻译** | 200万字符/月 | ¥49/百万字符 | 200+ | ✅ 无需VPN | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **腾讯云翻译** | 500万字符/月 | ¥58/千万字符 | 15+ | ✅ 无需VPN | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **阿里云翻译** | 100万字符/月 | ¥50/百万字符 | 200+ | ✅ 无需VPN | ⭐⭐⭐ | ⭐⭐⭐ |
| **Google Translate** | 50万字符/月 | $20/百万字符 | 130+ | ❌ 需要VPN | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **DeepL** | 50万字符/月 | $5/百万字符 | 30+ | ⚠️ 可能需要VPN | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 推荐方案

### 方案 1: 国际用户 / 需要多语言
**推荐使用 Azure Translator**
- 免费额度大
- 支持语言多
- 国内国外都能用
- 当前系统默认配置

### 方案 2: 国内用户 / 中文为主
**推荐使用百度翻译**
- 免费额度大
- 中文翻译质量好
- 速度快
- 价格便宜

### 方案 3: 预算充足 / 追求质量
**推荐使用 Google Translate 或 DeepL**
- Google: 综合质量最好
- DeepL: 欧洲语言翻译最佳

### 方案 4: 高频使用 / 成本敏感
**推荐使用腾讯云机器翻译**
- 免费额度最大（500 万字符/月）
- 超出后价格最便宜

---

## 常见问题

### Q1: 可以同时配置多个翻译服务吗？
A: 当前系统只支持单一翻译服务。如需支持多个，需要修改代码添加服务选择逻辑。

### Q2: 如何切换翻译服务？
A: 需要：
1. 修改 `translation.service.ts` 替换 API 调用代码
2. 更新 `.env` 环境变量
3. 重启后端服务

如需帮助，请联系开发者。

### Q3: 免费额度用完了怎么办？
A:
- 方案1: 等到下个月（免费额度按月重置）
- 方案2: 付费使用（大部分服务价格很便宜）
- 方案3: 切换到另一个免费额度更大的服务

### Q4: 如何查看翻译用量？
A: 每个服务商都提供控制台，可以查看用量：
- Azure: Azure Portal → 你的 Translator 资源 → 指标
- 百度: 百度翻译开放平台 → 管理控制台 → 用量统计
- 腾讯云: 腾讯云控制台 → 机器翻译 → 用量统计
- 阿里云: 阿里云控制台 → 机器翻译 → 用量中心
- Google: Google Cloud Console → Cloud Translation API → 指标
- DeepL: DeepL Account → Usage

### Q5: 翻译质量不满意怎么办？
A:
1. 尝试切换到翻译质量更好的服务（如 Google 或 DeepL）
2. 优化源文本（简洁、清晰的文本翻译效果更好）
3. 使用专业术语库（部分服务支持自定义术语）

---

## 技术支持

如需帮助切换翻译服务或遇到配置问题，请：
1. 查看本文档对应章节
2. 检查 `.env` 配置是否正确
3. 查看后端日志排查错误
4. 提交 Issue 到项目仓库

---

## 更新日志

- **2025-01-09**: 创建文档，添加 6 种翻译服务的配置教程
