# åŠŸèƒ½ 3 - æ¨¡æ¿ç®¡ç†ç³»ç»Ÿè¯¦ç»†è®¾è®¡

**ç‰ˆæœ¬ï¼š** 1.0
**åˆ›å»ºæ—¶é—´ï¼š** 2025-01-07
**é¢„è®¡è€—æ—¶ï¼š** 10 å°æ—¶
**ä¼˜å…ˆçº§ï¼š** é«˜

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [å˜é‡ç³»ç»Ÿè®¾è®¡](#å˜é‡ç³»ç»Ÿè®¾è®¡)
4. [åç«¯å¼€å‘è¯¦ç»†æ­¥éª¤](#åç«¯å¼€å‘è¯¦ç»†æ­¥éª¤)
5. [å‰ç«¯å¼€å‘è¯¦ç»†æ­¥éª¤](#å‰ç«¯å¼€å‘è¯¦ç»†æ­¥éª¤)
6. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
7. [æ–‡æ¡£æ›´æ–°æ¸…å•](#æ–‡æ¡£æ›´æ–°æ¸…å•)

---

## åŠŸèƒ½æ¦‚è¿°

### ä¸šåŠ¡ç›®æ ‡
å®ç°å®Œæ•´çš„æ¶ˆæ¯æ¨¡æ¿ç®¡ç†ç³»ç»Ÿï¼Œè®© BD äººå‘˜èƒ½å¤Ÿï¼š
- åˆ›å»ºå’Œç®¡ç†å¯å¤ç”¨çš„æ¶ˆæ¯æ¨¡æ¿
- ä½¿ç”¨å˜é‡å®ç°ä¸ªæ€§åŒ–æ¶ˆæ¯
- æŒ‰åœºæ™¯åˆ†ç±»æ¨¡æ¿ï¼ˆåˆæ¬¡è”ç³»ã€è·Ÿè¿›ã€è°ˆåˆ¤ç­‰ï¼‰
- é¢„è§ˆå˜é‡æ›¿æ¢åçš„æ•ˆæœ
- è¿½è¸ªæ¨¡æ¿ä½¿ç”¨æ•ˆæœ

### æ ¸å¿ƒç”¨ä¾‹
1. **åˆ›å»ºæ¨¡æ¿** - è¾“å…¥æ¨¡æ¿åç§°ã€åˆ†ç±»ã€å†…å®¹ï¼ˆå«å˜é‡ï¼‰
2. **ç¼–è¾‘æ¨¡æ¿** - ä¿®æ”¹ç°æœ‰æ¨¡æ¿
3. **åˆ é™¤æ¨¡æ¿** - åˆ é™¤ä¸å†ä½¿ç”¨çš„æ¨¡æ¿
4. **æŸ¥çœ‹åˆ—è¡¨** - æµè§ˆæ‰€æœ‰æ¨¡æ¿ï¼ŒæŒ‰åˆ†ç±»ç­›é€‰
5. **é¢„è§ˆæ¨¡æ¿** - é€‰æ‹© KOL åå®æ—¶é¢„è§ˆå˜é‡æ›¿æ¢æ•ˆæœ
6. **ä½¿ç”¨æ¨¡æ¿** - åœ¨è”ç³» KOL æ—¶é€‰æ‹©æ¨¡æ¿å¹¶è‡ªåŠ¨å¡«å……

### å…³é”®æŒ‡æ ‡
- **ä½¿ç”¨æ¬¡æ•°ï¼š** æ¨¡æ¿è¢«ä½¿ç”¨çš„æ€»æ¬¡æ•°
- **æˆåŠŸç‡ï¼š** (æ”¶åˆ°ç§¯æå›å¤æ¬¡æ•° / ä½¿ç”¨æ¬¡æ•°) Ã— 100%
- **å¹³å‡å“åº”æ—¶é—´ï¼š** ä½¿ç”¨è¯¥æ¨¡æ¿å KOL çš„å¹³å‡å“åº”æ—¶é•¿

---

## æ•°æ®åº“è®¾è®¡

### Template æ¨¡å‹ï¼ˆå·²å­˜åœ¨äº schema.prismaï¼‰

```prisma
model Template {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // æ¨¡æ¿æ•°æ®
  name         String
  category     String   // 'initial', 'followup', 'negotiation', 'collaboration', 'maintenance'
  content      String
  language     String   @default("en")
  aiGenerated  Boolean  @default(false)

  // ä½¿ç”¨ç»Ÿè®¡
  useCount     Int      @default(0)
  successCount Int      @default(0) // KOL å›å¤çš„æ¬¡æ•°

  // æ—¶é—´æˆ³
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // å…³ç³»
  contactLogs  ContactLog[]

  @@index([userId])
  @@index([category])
}
```

### æšä¸¾å€¼å®šä¹‰

**TemplateCategoryï¼ˆæ¨¡æ¿åˆ†ç±»ï¼‰ï¼š**
- `initial` - åˆæ¬¡è”ç³»
- `followup` - è·Ÿè¿›è”ç³»
- `negotiation` - ä»·æ ¼è°ˆåˆ¤
- `collaboration` - åˆä½œç»†èŠ‚è®¨è®º
- `maintenance` - å…³ç³»ç»´æŠ¤

**Languageï¼ˆè¯­è¨€ï¼‰ï¼š**
- `en` - è‹±è¯­
- `zh` - ä¸­æ–‡
- `es` - è¥¿ç­ç‰™è¯­
- `pt` - è‘¡è„ç‰™è¯­
- ç­‰ç­‰...

---

## å˜é‡ç³»ç»Ÿè®¾è®¡

### æ”¯æŒçš„å˜é‡

#### KOL ç›¸å…³å˜é‡
```typescript
{
  "{{username}}": "cryptotrader_pro",           // Twitter ç”¨æˆ·åï¼ˆä¸å¸¦@ï¼‰
  "{{display_name}}": "Crypto Trader Pro",     // æ˜¾ç¤ºåç§°
  "{{follower_count}}": "15,000",              // ç²‰ä¸æ•°ï¼ˆæ ¼å¼åŒ–ï¼‰
  "{{bio}}": "Contract trading expert...",      // ä¸ªäººç®€ä»‹
  "{{profile_url}}": "https://twitter.com/...", // Twitter ä¸»é¡µé“¾æ¥
}
```

#### ç”¨æˆ·ç›¸å…³å˜é‡
```typescript
{
  "{{my_name}}": "Alex Chen",                  // BD äººå‘˜å§“å
  "{{my_email}}": "alex@kcex.com",            // BD äººå‘˜é‚®ç®±
  "{{exchange_name}}": "KCEX",                 // äº¤æ˜“æ‰€åç§°
}
```

#### ç³»ç»Ÿå˜é‡
```typescript
{
  "{{today}}": "2025-01-07",                   // ä»Šå¤©æ—¥æœŸ
  "{{today_cn}}": "2025å¹´1æœˆ7æ—¥",              // ä»Šå¤©æ—¥æœŸï¼ˆä¸­æ–‡ï¼‰
}
```

### å˜é‡æ›¿æ¢å‡½æ•°

```typescript
/**
 * æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
 * @param template æ¨¡æ¿å†…å®¹
 * @param variables å˜é‡æ˜ å°„å¯¹è±¡
 * @returns æ›¿æ¢åçš„æ–‡æœ¬
 */
function replaceVariables(template: string, variables: Record<string, string>): string {
  let result = template;

  for (const [key, value] of Object.entries(variables)) {
    const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    result = result.replace(regex, value || '');
  }

  return result;
}
```

### å˜é‡éªŒè¯

æ¨¡æ¿å†…å®¹ä¸­çš„å˜é‡å¿…é¡»ç¬¦åˆæ ¼å¼ï¼š`{{variable_name}}`
- ä½¿ç”¨åŒèŠ±æ‹¬å·åŒ…è£¹
- å˜é‡ååªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
- å˜é‡åä¸èƒ½ä»¥æ•°å­—å¼€å¤´

**æ­£åˆ™è¡¨è¾¾å¼ï¼š** `/\{\{([a-z_][a-z0-9_]*)\}\}/g`

---

## åç«¯å¼€å‘è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 3.1ï¼šåˆ›å»º DTO å±‚ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`backend/src/features/template/dto/create-template.dto.ts`

```typescript
import { z } from 'zod';

/**
 * åˆ›å»ºæ¨¡æ¿ DTO
 */
export const CreateTemplateSchema = z.object({
  name: z
    .string()
    .min(1, 'æ¨¡æ¿åç§°ä¸èƒ½ä¸ºç©º')
    .max(100, 'æ¨¡æ¿åç§°ä¸èƒ½è¶…è¿‡ 100 å­—ç¬¦'),

  category: z
    .enum(['initial', 'followup', 'negotiation', 'collaboration', 'maintenance'], {
      errorMap: () => ({ message: 'æ¨¡æ¿åˆ†ç±»å¿…é¡»æ˜¯: initial, followup, negotiation, collaboration, maintenance' }),
    }),

  content: z
    .string()
    .min(1, 'æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©º')
    .max(5000, 'æ¨¡æ¿å†…å®¹ä¸èƒ½è¶…è¿‡ 5000 å­—ç¬¦')
    .refine(
      (content) => {
        // éªŒè¯å˜é‡æ ¼å¼
        const variableRegex = /\{\{([a-z_][a-z0-9_]*)\}\}/g;
        const invalidVariables = content.match(/\{\{[^}]*\}\}/g)?.filter(
          (v) => !variableRegex.test(v)
        );
        return !invalidVariables || invalidVariables.length === 0;
      },
      {
        message: 'æ¨¡æ¿ä¸­åŒ…å«æ ¼å¼é”™è¯¯çš„å˜é‡ï¼Œå˜é‡æ ¼å¼åº”ä¸º {{variable_name}}',
      }
    ),

  language: z
    .string()
    .length(2, 'è¯­è¨€ä»£ç å¿…é¡»æ˜¯ 2 ä¸ªå­—ç¬¦')
    .default('en'),

  aiGenerated: z
    .boolean()
    .default(false),
});

export type CreateTemplateDto = z.infer<typeof CreateTemplateSchema>;
```

#### æ–‡ä»¶ï¼š`backend/src/features/template/dto/update-template.dto.ts`

```typescript
import { z } from 'zod';
import { CreateTemplateSchema } from './create-template.dto';

/**
 * æ›´æ–°æ¨¡æ¿ DTOï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰
 */
export const UpdateTemplateSchema = CreateTemplateSchema.partial();

export type UpdateTemplateDto = z.infer<typeof UpdateTemplateSchema>;
```

#### æ–‡ä»¶ï¼š`backend/src/features/template/dto/template-query.dto.ts`

```typescript
import { z } from 'zod';

/**
 * æ¨¡æ¿æŸ¥è¯¢å‚æ•° DTO
 */
export const TemplateQuerySchema = z.object({
  // åˆ†ç±»ç­›é€‰
  category: z
    .enum(['initial', 'followup', 'negotiation', 'collaboration', 'maintenance'])
    .optional(),

  // æœç´¢ï¼ˆæ¨¡æ¿åç§°æˆ–å†…å®¹ï¼‰
  search: z
    .string()
    .optional(),

  // è¯­è¨€ç­›é€‰
  language: z
    .string()
    .length(2)
    .optional(),

  // æ˜¯å¦ AI ç”Ÿæˆ
  aiGenerated: z
    .string()
    .transform((val) => val === 'true')
    .optional(),

  // åˆ†é¡µ
  page: z
    .string()
    .transform((val) => parseInt(val, 10))
    .pipe(z.number().int().min(1))
    .default('1'),

  limit: z
    .string()
    .transform((val) => parseInt(val, 10))
    .pipe(z.number().int().min(1).max(100))
    .default('20'),

  // æ’åº
  sortBy: z
    .enum(['createdAt', 'updatedAt', 'useCount', 'name'])
    .default('createdAt'),

  sortOrder: z
    .enum(['asc', 'desc'])
    .default('desc'),
});

export type TemplateQueryDto = z.infer<typeof TemplateQuerySchema>;
```

#### æ–‡ä»¶ï¼š`backend/src/features/template/dto/preview-template.dto.ts`

```typescript
import { z } from 'zod';

/**
 * æ¨¡æ¿é¢„è§ˆ DTO
 */
export const PreviewTemplateSchema = z.object({
  templateId: z
    .number()
    .int('æ¨¡æ¿ ID å¿…é¡»æ˜¯æ•´æ•°')
    .positive('æ¨¡æ¿ ID å¿…é¡»æ˜¯æ­£æ•°')
    .optional(),

  content: z
    .string()
    .min(1, 'æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©º'),

  kolId: z
    .number()
    .int('KOL ID å¿…é¡»æ˜¯æ•´æ•°')
    .positive('KOL ID å¿…é¡»æ˜¯æ­£æ•°')
    .optional(),
});

export type PreviewTemplateDto = z.infer<typeof PreviewTemplateSchema>;
```

---

### æ­¥éª¤ 3.2ï¼šåˆ›å»º Service å±‚ï¼ˆçº¦ 1.5 å°æ—¶ï¼‰

#### æ–‡ä»¶ï¼š`backend/src/features/template/services/template.service.ts`

```typescript
import { PrismaClient } from '@prisma/client';
import { CreateTemplateDto } from '../dto/create-template.dto';
import { UpdateTemplateDto } from '../dto/update-template.dto';
import { TemplateQueryDto } from '../dto/template-query.dto';
import { PreviewTemplateDto } from '../dto/preview-template.dto';
import { logger } from '@/utils/logger';
import { AppError } from '@/utils/errors';

const prisma = new PrismaClient();

/**
 * æ¨¡æ¿æœåŠ¡ç±»
 */
export class TemplateService {
  /**
   * åˆ›å»ºæ¨¡æ¿
   */
  async createTemplate(userId: number, data: CreateTemplateDto) {
    try {
      const template = await prisma.template.create({
        data: {
          userId,
          name: data.name,
          category: data.category,
          content: data.content,
          language: data.language || 'en',
          aiGenerated: data.aiGenerated || false,
        },
      });

      logger.info(`æ¨¡æ¿åˆ›å»ºæˆåŠŸ: ID ${template.id}, åç§°: ${template.name}`);

      return template;
    } catch (error) {
      logger.error('åˆ›å»ºæ¨¡æ¿å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ã€æ’åºï¼‰
   */
  async getTemplates(userId: number, query: TemplateQueryDto) {
    try {
      // æ„å»ºç­›é€‰æ¡ä»¶
      const where: any = { userId };

      if (query.category) {
        where.category = query.category;
      }

      if (query.language) {
        where.language = query.language;
      }

      if (query.aiGenerated !== undefined) {
        where.aiGenerated = query.aiGenerated;
      }

      if (query.search) {
        where.OR = [
          { name: { contains: query.search } },
          { content: { contains: query.search } },
        ];
      }

      // è®¡ç®—åˆ†é¡µ
      const page = query.page || 1;
      const limit = query.limit || 20;
      const skip = (page - 1) * limit;

      // æ’åº
      const orderBy: any = {};
      orderBy[query.sortBy || 'createdAt'] = query.sortOrder || 'desc';

      // æŸ¥è¯¢æ•°æ®
      const [templates, total] = await Promise.all([
        prisma.template.findMany({
          where,
          skip,
          take: limit,
          orderBy,
        }),
        prisma.template.count({ where }),
      ]);

      logger.info(`æŸ¥è¯¢æ¨¡æ¿æˆåŠŸ: ${templates.length} æ¡, æ€»è®¡: ${total}`);

      return {
        data: templates,
        pagination: {
          page,
          limit,
          total,
          totalPages: Math.ceil(total / limit),
        },
      };
    } catch (error) {
      logger.error('æŸ¥è¯¢æ¨¡æ¿å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * è·å–å•ä¸ªæ¨¡æ¿è¯¦æƒ…
   */
  async getTemplateById(userId: number, id: number) {
    try {
      const template = await prisma.template.findFirst({
        where: { id, userId },
      });

      if (!template) {
        throw new AppError('æ¨¡æ¿ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®', 404);
      }

      logger.info(`æŸ¥è¯¢æ¨¡æ¿è¯¦æƒ…æˆåŠŸ: ID ${id}`);

      return template;
    } catch (error) {
      logger.error('æŸ¥è¯¢æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ›´æ–°æ¨¡æ¿
   */
  async updateTemplate(userId: number, id: number, data: UpdateTemplateDto) {
    try {
      // éªŒè¯æ¨¡æ¿å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
      const existingTemplate = await prisma.template.findFirst({
        where: { id, userId },
      });

      if (!existingTemplate) {
        throw new AppError('æ¨¡æ¿ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®', 404);
      }

      // æ›´æ–°æ¨¡æ¿
      const template = await prisma.template.update({
        where: { id },
        data: {
          ...(data.name && { name: data.name }),
          ...(data.category && { category: data.category }),
          ...(data.content && { content: data.content }),
          ...(data.language && { language: data.language }),
          ...(data.aiGenerated !== undefined && { aiGenerated: data.aiGenerated }),
        },
      });

      logger.info(`æ¨¡æ¿æ›´æ–°æˆåŠŸ: ID ${id}`);

      return template;
    } catch (error) {
      logger.error('æ›´æ–°æ¨¡æ¿å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * åˆ é™¤æ¨¡æ¿
   */
  async deleteTemplate(userId: number, id: number) {
    try {
      // éªŒè¯æ¨¡æ¿å­˜åœ¨ä¸”å±äºå½“å‰ç”¨æˆ·
      const template = await prisma.template.findFirst({
        where: { id, userId },
      });

      if (!template) {
        throw new AppError('æ¨¡æ¿ä¸å­˜åœ¨æˆ–æ— æƒé™è®¿é—®', 404);
      }

      // åˆ é™¤æ¨¡æ¿
      await prisma.template.delete({
        where: { id },
      });

      logger.info(`æ¨¡æ¿åˆ é™¤æˆåŠŸ: ID ${id}`);

      return { message: 'æ¨¡æ¿åˆ é™¤æˆåŠŸ' };
    } catch (error) {
      logger.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * é¢„è§ˆæ¨¡æ¿ï¼ˆå˜é‡æ›¿æ¢ï¼‰
   */
  async previewTemplate(userId: number, data: PreviewTemplateDto) {
    try {
      let templateContent = data.content;

      // å¦‚æœæä¾›äº† templateIdï¼Œè·å–æ¨¡æ¿å†…å®¹
      if (data.templateId) {
        const template = await this.getTemplateById(userId, data.templateId);
        templateContent = template.content;
      }

      // æ„å»ºå˜é‡æ˜ å°„
      const variables: Record<string, string> = {};

      // æ·»åŠ ç”¨æˆ·å˜é‡
      const user = await prisma.user.findUnique({
        where: { id: userId },
      });

      if (user) {
        variables['{{my_name}}'] = user.fullName;
        variables['{{my_email}}'] = user.email;
        variables['{{exchange_name}}'] = 'KCEX';
      }

      // æ·»åŠ ç³»ç»Ÿå˜é‡
      const today = new Date();
      variables['{{today}}'] = today.toISOString().split('T')[0];
      variables['{{today_cn}}'] = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;

      // å¦‚æœæä¾›äº† kolIdï¼Œæ·»åŠ  KOL å˜é‡
      if (data.kolId) {
        const kol = await prisma.kOL.findFirst({
          where: { id: data.kolId, userId },
        });

        if (kol) {
          variables['{{username}}'] = kol.username;
          variables['{{display_name}}'] = kol.displayName;
          variables['{{follower_count}}'] = kol.followerCount.toLocaleString();
          variables['{{bio}}'] = kol.bio || '';
          variables['{{profile_url}}'] = `https://twitter.com/${kol.username}`;
        }
      }

      // æ›¿æ¢å˜é‡
      const previewContent = this.replaceVariables(templateContent, variables);

      logger.info('æ¨¡æ¿é¢„è§ˆç”ŸæˆæˆåŠŸ');

      return {
        originalContent: templateContent,
        previewContent,
        variables,
      };
    } catch (error) {
      logger.error('é¢„è§ˆæ¨¡æ¿å¤±è´¥:', error);
      throw error;
    }
  }

  /**
   * æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
   */
  private replaceVariables(template: string, variables: Record<string, string>): string {
    let result = template;

    for (const [key, value] of Object.entries(variables)) {
      const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      result = result.replace(regex, value || '');
    }

    return result;
  }

  /**
   * æå–æ¨¡æ¿ä¸­çš„å˜é‡
   */
  extractVariables(template: string): string[] {
    const regex = /\{\{([a-z_][a-z0-9_]*)\}\}/g;
    const matches = template.matchAll(regex);
    const variables = Array.from(matches, (match) => `{{${match[1]}}}`);
    return Array.from(new Set(variables)); // å»é‡
  }
}

export const templateService = new TemplateService();
```

---

### æ­¥éª¤ 3.3ï¼šåˆ›å»º Controller å±‚ï¼ˆçº¦ 45 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`backend/src/features/template/controllers/template.controller.ts`

```typescript
import { Request, Response } from 'express';
import { templateService } from '../services/template.service';
import { CreateTemplateSchema } from '../dto/create-template.dto';
import { UpdateTemplateSchema } from '../dto/update-template.dto';
import { TemplateQuerySchema } from '../dto/template-query.dto';
import { PreviewTemplateSchema } from '../dto/preview-template.dto';
import { asyncHandler } from '@/utils/async-handler';
import { AppError } from '@/utils/errors';

/**
 * æ¨¡æ¿æ§åˆ¶å™¨
 */
export class TemplateController {
  /**
   * åˆ›å»ºæ¨¡æ¿
   * POST /api/v1/templates
   */
  createTemplate = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;

    // éªŒè¯è¯·æ±‚ä½“
    const validatedData = CreateTemplateSchema.parse(req.body);

    // åˆ›å»ºæ¨¡æ¿
    const template = await templateService.createTemplate(userId, validatedData);

    res.status(201).json({
      success: true,
      message: 'æ¨¡æ¿åˆ›å»ºæˆåŠŸ',
      data: template,
    });
  });

  /**
   * è·å–æ¨¡æ¿åˆ—è¡¨
   * GET /api/v1/templates
   */
  getTemplates = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;

    // éªŒè¯æŸ¥è¯¢å‚æ•°
    const query = TemplateQuerySchema.parse(req.query);

    // æŸ¥è¯¢æ•°æ®
    const result = await templateService.getTemplates(userId, query);

    res.status(200).json({
      success: true,
      message: 'æ¨¡æ¿æŸ¥è¯¢æˆåŠŸ',
      ...result,
    });
  });

  /**
   * è·å–æ¨¡æ¿è¯¦æƒ…
   * GET /api/v1/templates/:id
   */
  getTemplateById = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;
    const id = parseInt(req.params.id, 10);

    if (isNaN(id)) {
      throw new AppError('æ— æ•ˆçš„æ¨¡æ¿ ID', 400);
    }

    const template = await templateService.getTemplateById(userId, id);

    res.status(200).json({
      success: true,
      message: 'æ¨¡æ¿æŸ¥è¯¢æˆåŠŸ',
      data: template,
    });
  });

  /**
   * æ›´æ–°æ¨¡æ¿
   * PUT /api/v1/templates/:id
   */
  updateTemplate = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;
    const id = parseInt(req.params.id, 10);

    if (isNaN(id)) {
      throw new AppError('æ— æ•ˆçš„æ¨¡æ¿ ID', 400);
    }

    // éªŒè¯è¯·æ±‚ä½“
    const validatedData = UpdateTemplateSchema.parse(req.body);

    // æ›´æ–°æ¨¡æ¿
    const template = await templateService.updateTemplate(userId, id, validatedData);

    res.status(200).json({
      success: true,
      message: 'æ¨¡æ¿æ›´æ–°æˆåŠŸ',
      data: template,
    });
  });

  /**
   * åˆ é™¤æ¨¡æ¿
   * DELETE /api/v1/templates/:id
   */
  deleteTemplate = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;
    const id = parseInt(req.params.id, 10);

    if (isNaN(id)) {
      throw new AppError('æ— æ•ˆçš„æ¨¡æ¿ ID', 400);
    }

    const result = await templateService.deleteTemplate(userId, id);

    res.status(200).json({
      success: true,
      ...result,
    });
  });

  /**
   * é¢„è§ˆæ¨¡æ¿
   * POST /api/v1/templates/preview
   */
  previewTemplate = asyncHandler(async (req: Request, res: Response) => {
    const userId = req.user!.id;

    // éªŒè¯è¯·æ±‚ä½“
    const validatedData = PreviewTemplateSchema.parse(req.body);

    // ç”Ÿæˆé¢„è§ˆ
    const preview = await templateService.previewTemplate(userId, validatedData);

    res.status(200).json({
      success: true,
      message: 'æ¨¡æ¿é¢„è§ˆç”ŸæˆæˆåŠŸ',
      data: preview,
    });
  });
}

export const templateController = new TemplateController();
```

---

### æ­¥éª¤ 3.4ï¼šåˆ›å»º Routes å±‚ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`backend/src/features/template/routes/template.routes.ts`

```typescript
import { Router } from 'express';
import { templateController } from '../controllers/template.controller';
import { requireAuth } from '@/middlewares/auth.middleware';

const router = Router();

// æ‰€æœ‰è·¯ç”±éœ€è¦è®¤è¯
router.use(requireAuth);

/**
 * @route   POST /api/v1/templates
 * @desc    åˆ›å»ºæ¨¡æ¿
 * @access  Private
 */
router.post('/', templateController.createTemplate);

/**
 * @route   POST /api/v1/templates/preview
 * @desc    é¢„è§ˆæ¨¡æ¿ï¼ˆå˜é‡æ›¿æ¢ï¼‰
 * @access  Private
 */
router.post('/preview', templateController.previewTemplate);

/**
 * @route   GET /api/v1/templates
 * @desc    è·å–æ¨¡æ¿åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
 * @access  Private
 */
router.get('/', templateController.getTemplates);

/**
 * @route   GET /api/v1/templates/:id
 * @desc    è·å–æ¨¡æ¿è¯¦æƒ…
 * @access  Private
 */
router.get('/:id', templateController.getTemplateById);

/**
 * @route   PUT /api/v1/templates/:id
 * @desc    æ›´æ–°æ¨¡æ¿
 * @access  Private
 */
router.put('/:id', templateController.updateTemplate);

/**
 * @route   DELETE /api/v1/templates/:id
 * @desc    åˆ é™¤æ¨¡æ¿
 * @access  Private
 */
router.delete('/:id', templateController.deleteTemplate);

export default router;
```

---

### æ­¥éª¤ 3.5ï¼šæ³¨å†Œè·¯ç”±åˆ°ä¸»åº”ç”¨ï¼ˆçº¦ 10 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`backend/src/routes/index.ts`

åœ¨å·²æœ‰çš„è·¯ç”±æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```typescript
import templateRoutes from '@/features/template/routes/template.routes';

// ... å…¶ä»–è·¯ç”±

// æ¨¡æ¿è·¯ç”±
router.use('/templates', templateRoutes);
```

---

## å‰ç«¯å¼€å‘è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 3.6ï¼šåˆ›å»ºç±»å‹å®šä¹‰ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`frontend/src/types/template.ts`

```typescript
/**
 * æ¨¡æ¿ç±»å‹å®šä¹‰
 */

export type TemplateCategory = 'initial' | 'followup' | 'negotiation' | 'collaboration' | 'maintenance';

/**
 * æ¨¡æ¿æ¥å£
 */
export interface Template {
  id: number;
  userId: number;
  name: string;
  category: TemplateCategory;
  content: string;
  language: string;
  aiGenerated: boolean;
  useCount: number;
  successCount: number;
  createdAt: string;
  updatedAt: string;
}

/**
 * åˆ›å»ºæ¨¡æ¿ DTO
 */
export interface CreateTemplateDto {
  name: string;
  category: TemplateCategory;
  content: string;
  language?: string;
  aiGenerated?: boolean;
}

/**
 * æ›´æ–°æ¨¡æ¿ DTO
 */
export interface UpdateTemplateDto {
  name?: string;
  category?: TemplateCategory;
  content?: string;
  language?: string;
  aiGenerated?: boolean;
}

/**
 * æ¨¡æ¿æŸ¥è¯¢å‚æ•°
 */
export interface TemplateQueryParams {
  category?: TemplateCategory;
  search?: string;
  language?: string;
  aiGenerated?: boolean;
  page?: number;
  limit?: number;
  sortBy?: 'createdAt' | 'updatedAt' | 'useCount' | 'name';
  sortOrder?: 'asc' | 'desc';
}

/**
 * æ¨¡æ¿é¢„è§ˆè¯·æ±‚
 */
export interface PreviewTemplateDto {
  templateId?: number;
  content: string;
  kolId?: number;
}

/**
 * æ¨¡æ¿é¢„è§ˆå“åº”
 */
export interface TemplatePreview {
  originalContent: string;
  previewContent: string;
  variables: Record<string, string>;
}

/**
 * æ¨¡æ¿åˆ†ç±»é…ç½®
 */
export const TEMPLATE_CATEGORY_CONFIG: Record<TemplateCategory, { label: string; color: string; icon: string }> = {
  initial: { label: 'åˆæ¬¡è”ç³»', color: '#1890ff', icon: 'âœ‰ï¸' },
  followup: { label: 'è·Ÿè¿›è”ç³»', color: '#52c41a', icon: 'ğŸ”„' },
  negotiation: { label: 'ä»·æ ¼è°ˆåˆ¤', color: '#faad14', icon: 'ğŸ’°' },
  collaboration: { label: 'åˆä½œç»†èŠ‚', color: '#722ed1', icon: 'ğŸ¤' },
  maintenance: { label: 'å…³ç³»ç»´æŠ¤', color: '#eb2f96', icon: 'ğŸ’' },
};

/**
 * æ”¯æŒçš„å˜é‡åˆ—è¡¨
 */
export const AVAILABLE_VARIABLES = [
  {
    category: 'KOL ä¿¡æ¯',
    variables: [
      { name: '{{username}}', description: 'Twitter ç”¨æˆ·å', example: 'cryptotrader_pro' },
      { name: '{{display_name}}', description: 'æ˜¾ç¤ºåç§°', example: 'Crypto Trader Pro' },
      { name: '{{follower_count}}', description: 'ç²‰ä¸æ•°ï¼ˆæ ¼å¼åŒ–ï¼‰', example: '15,000' },
      { name: '{{bio}}', description: 'ä¸ªäººç®€ä»‹', example: 'Contract trading expert...' },
      { name: '{{profile_url}}', description: 'Twitter ä¸»é¡µé“¾æ¥', example: 'https://twitter.com/...' },
    ],
  },
  {
    category: 'ä¸ªäººä¿¡æ¯',
    variables: [
      { name: '{{my_name}}', description: 'æˆ‘çš„å§“å', example: 'Alex Chen' },
      { name: '{{my_email}}', description: 'æˆ‘çš„é‚®ç®±', example: 'alex@kcex.com' },
      { name: '{{exchange_name}}', description: 'äº¤æ˜“æ‰€åç§°', example: 'KCEX' },
    ],
  },
  {
    category: 'ç³»ç»Ÿå˜é‡',
    variables: [
      { name: '{{today}}', description: 'ä»Šå¤©æ—¥æœŸ', example: '2025-01-07' },
      { name: '{{today_cn}}', description: 'ä»Šå¤©æ—¥æœŸï¼ˆä¸­æ–‡ï¼‰', example: '2025å¹´1æœˆ7æ—¥' },
    ],
  },
];
```

---

### æ­¥éª¤ 3.7ï¼šåˆ›å»º API æœåŠ¡å±‚ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`frontend/src/services/template.service.ts`

```typescript
import apiClient from './api-client';
import type {
  Template,
  CreateTemplateDto,
  UpdateTemplateDto,
  TemplateQueryParams,
  PreviewTemplateDto,
  TemplatePreview,
} from '@/types/template';
import type { PaginatedResponse } from '@/types/common';

/**
 * æ¨¡æ¿ API æœåŠ¡
 */

/**
 * åˆ›å»ºæ¨¡æ¿
 */
export const createTemplate = async (data: CreateTemplateDto): Promise<Template> => {
  const response = await apiClient.post<{ data: Template }>('/templates', data);
  return response.data.data;
};

/**
 * è·å–æ¨¡æ¿åˆ—è¡¨
 */
export const getTemplates = async (
  params?: TemplateQueryParams
): Promise<PaginatedResponse<Template>> => {
  const response = await apiClient.get<PaginatedResponse<Template>>('/templates', { params });
  return response.data;
};

/**
 * è·å–æ¨¡æ¿è¯¦æƒ…
 */
export const getTemplateById = async (id: number): Promise<Template> => {
  const response = await apiClient.get<{ data: Template }>(`/templates/${id}`);
  return response.data.data;
};

/**
 * æ›´æ–°æ¨¡æ¿
 */
export const updateTemplate = async (id: number, data: UpdateTemplateDto): Promise<Template> => {
  const response = await apiClient.put<{ data: Template }>(`/templates/${id}`, data);
  return response.data.data;
};

/**
 * åˆ é™¤æ¨¡æ¿
 */
export const deleteTemplate = async (id: number): Promise<void> => {
  await apiClient.delete(`/templates/${id}`);
};

/**
 * é¢„è§ˆæ¨¡æ¿
 */
export const previewTemplate = async (data: PreviewTemplateDto): Promise<TemplatePreview> => {
  const response = await apiClient.post<{ data: TemplatePreview }>('/templates/preview', data);
  return response.data.data;
};
```

---

### æ­¥éª¤ 3.8ï¼šåˆ›å»ºçŠ¶æ€ç®¡ç†ï¼ˆçº¦ 45 åˆ†é’Ÿï¼‰

#### æ–‡ä»¶ï¼š`frontend/src/store/template.store.ts`

```typescript
import { create } from 'zustand';
import type { Template, TemplateQueryParams } from '@/types/template';
import * as templateService from '@/services/template.service';
import { message } from 'antd';

/**
 * æ¨¡æ¿çŠ¶æ€ç®¡ç†
 */

interface TemplateState {
  // æ•°æ®çŠ¶æ€
  templates: Template[];
  currentTemplate: Template | null;
  loading: boolean;

  // åˆ†é¡µçŠ¶æ€
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };

  // æŸ¥è¯¢å‚æ•°
  queryParams: TemplateQueryParams;

  // Actions
  fetchTemplates: () => Promise<void>;
  fetchTemplateById: (id: number) => Promise<void>;
  createTemplate: (data: any) => Promise<void>;
  updateTemplate: (id: number, data: any) => Promise<void>;
  deleteTemplate: (id: number) => Promise<void>;
  setQueryParams: (params: Partial<TemplateQueryParams>) => void;
  resetQueryParams: () => void;
}

const defaultQueryParams: TemplateQueryParams = {
  page: 1,
  limit: 20,
  sortBy: 'createdAt',
  sortOrder: 'desc',
};

export const useTemplateStore = create<TemplateState>((set, get) => ({
  // åˆå§‹çŠ¶æ€
  templates: [],
  currentTemplate: null,
  loading: false,
  pagination: {
    page: 1,
    limit: 20,
    total: 0,
    totalPages: 0,
  },
  queryParams: defaultQueryParams,

  // è·å–æ¨¡æ¿åˆ—è¡¨
  fetchTemplates: async () => {
    set({ loading: true });
    try {
      const response = await templateService.getTemplates(get().queryParams);
      set({
        templates: response.data,
        pagination: response.pagination,
        loading: false,
      });
    } catch (error: any) {
      message.error(error.response?.data?.message || 'è·å–æ¨¡æ¿åˆ—è¡¨å¤±è´¥');
      set({ loading: false });
    }
  },

  // è·å–æ¨¡æ¿è¯¦æƒ…
  fetchTemplateById: async (id: number) => {
    set({ loading: true });
    try {
      const template = await templateService.getTemplateById(id);
      set({ currentTemplate: template, loading: false });
    } catch (error: any) {
      message.error(error.response?.data?.message || 'è·å–æ¨¡æ¿è¯¦æƒ…å¤±è´¥');
      set({ loading: false });
    }
  },

  // åˆ›å»ºæ¨¡æ¿
  createTemplate: async (data: any) => {
    set({ loading: true });
    try {
      await templateService.createTemplate(data);
      message.success('æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
      await get().fetchTemplates();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'åˆ›å»ºæ¨¡æ¿å¤±è´¥');
      set({ loading: false });
      throw error;
    }
  },

  // æ›´æ–°æ¨¡æ¿
  updateTemplate: async (id: number, data: any) => {
    set({ loading: true });
    try {
      await templateService.updateTemplate(id, data);
      message.success('æ¨¡æ¿æ›´æ–°æˆåŠŸ');
      await get().fetchTemplates();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'æ›´æ–°æ¨¡æ¿å¤±è´¥');
      set({ loading: false });
      throw error;
    }
  },

  // åˆ é™¤æ¨¡æ¿
  deleteTemplate: async (id: number) => {
    set({ loading: true });
    try {
      await templateService.deleteTemplate(id);
      message.success('æ¨¡æ¿åˆ é™¤æˆåŠŸ');
      await get().fetchTemplates();
    } catch (error: any) {
      message.error(error.response?.data?.message || 'åˆ é™¤æ¨¡æ¿å¤±è´¥');
      set({ loading: false });
    }
  },

  // è®¾ç½®æŸ¥è¯¢å‚æ•°
  setQueryParams: (params: Partial<TemplateQueryParams>) => {
    set((state) => ({
      queryParams: { ...state.queryParams, ...params, page: 1 },
    }));
  },

  // é‡ç½®æŸ¥è¯¢å‚æ•°
  resetQueryParams: () => {
    set({ queryParams: defaultQueryParams });
  },
}));
```

---

## æµ‹è¯•è®¡åˆ’

### åç«¯æµ‹è¯•ï¼ˆä½¿ç”¨ curl æˆ– Postmanï¼‰

1. âœ… åˆ›å»ºæ¨¡æ¿
2. âœ… æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
3. âœ… æŸ¥è¯¢æ¨¡æ¿è¯¦æƒ…
4. âœ… æ›´æ–°æ¨¡æ¿
5. âœ… åˆ é™¤æ¨¡æ¿
6. âœ… é¢„è§ˆæ¨¡æ¿ï¼ˆä¸å¸¦ KOLï¼‰
7. âœ… é¢„è§ˆæ¨¡æ¿ï¼ˆå¸¦ KOLï¼‰
8. âœ… éªŒè¯å˜é‡æ›¿æ¢
9. âœ… éªŒè¯ç”¨æˆ·æ•°æ®éš”ç¦»

### å‰ç«¯æµ‹è¯•

1. âœ… æ¨¡æ¿åˆ—è¡¨åŠ è½½
2. âœ… ç­›é€‰å’Œæ’åºåŠŸèƒ½
3. âœ… åˆ›å»ºæ¨¡æ¿
4. âœ… ç¼–è¾‘æ¨¡æ¿
5. âœ… åˆ é™¤æ¨¡æ¿
6. âœ… å˜é‡æ’å…¥åŠŸèƒ½
7. âœ… å®æ—¶é¢„è§ˆåŠŸèƒ½
8. âœ… å“åº”å¼è®¾è®¡
9. âœ… é”™è¯¯å¤„ç†å’Œæç¤º

---

## æ–‡æ¡£æ›´æ–°æ¸…å•

- [ ] `docs/API.md` - æ·»åŠ æ¨¡æ¿ API æ–‡æ¡£
- [ ] `docs/å¼€å‘ä»»åŠ¡.md` - æ›´æ–°ä»»åŠ¡çŠ¶æ€
- [ ] `README.md` - æ·»åŠ æ¨¡æ¿ç®¡ç†åŠŸèƒ½è¯´æ˜
- [ ] `docs/æµ‹è¯•æŠ¥å‘Š.md` - æ·»åŠ æ¨¡æ¿æµ‹è¯•ç»“æœ
- [ ] Git æäº¤ - æäº¤æ‰€æœ‰ä»£ç 

---

## é¢„è®¡è€—æ—¶æ€»ç»“

| é˜¶æ®µ | å­ä»»åŠ¡ | é¢„è®¡è€—æ—¶ |
|------|--------|----------|
| åç«¯ | 3.1 DTO å±‚ | 30 åˆ†é’Ÿ |
| åç«¯ | 3.2 Service å±‚ | 1.5 å°æ—¶ |
| åç«¯ | 3.3 Controller å±‚ | 45 åˆ†é’Ÿ |
| åç«¯ | 3.4 Routes å±‚ | 30 åˆ†é’Ÿ |
| åç«¯ | 3.5 æ³¨å†Œè·¯ç”± | 10 åˆ†é’Ÿ |
| å‰ç«¯ | 3.6 ç±»å‹å®šä¹‰ | 30 åˆ†é’Ÿ |
| å‰ç«¯ | 3.7 API æœåŠ¡ | 30 åˆ†é’Ÿ |
| å‰ç«¯ | 3.8 çŠ¶æ€ç®¡ç† | 45 åˆ†é’Ÿ |
| å‰ç«¯ | 3.9 å¤ç”¨ç»„ä»¶ | 2 å°æ—¶ |
| å‰ç«¯ | 3.10 é¡µé¢ç»„ä»¶ | 1.5 å°æ—¶ |
| å‰ç«¯ | 3.11 é…ç½®è·¯ç”± | 15 åˆ†é’Ÿ |
| æµ‹è¯• | åç«¯æµ‹è¯• | 30 åˆ†é’Ÿ |
| æµ‹è¯• | å‰ç«¯æµ‹è¯• | 30 åˆ†é’Ÿ |
| æ–‡æ¡£ | æ–‡æ¡£æ›´æ–° | 30 åˆ†é’Ÿ |
| **æ€»è®¡** | | **çº¦ 10 å°æ—¶** |

---

**å¤‡æ³¨ï¼š**
- æ•°æ®åº“æ¨¡å‹å·²å­˜åœ¨äº `schema.prisma`ï¼Œæ— éœ€ä¿®æ”¹
- å˜é‡ç³»ç»Ÿæ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œéœ€è¦ä»”ç»†æµ‹è¯•
- ä¿æŒä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´ï¼ˆTypeScriptã€ä¸­æ–‡æ³¨é‡Šã€åˆ†å±‚æ¶æ„ï¼‰
- å‰ç«¯ç»„ä»¶è®¾è®¡è¯¦è§åç»­æ–‡æ¡£
