# 开发任务跟踪

本文档记录所有开发任务、需求和注意事项。

## 📌 开发流程规范

### 每个功能的开发步骤：
1. **需求分析** - 记录到本文档
2. **后端开发** - Service → Controller → Routes
3. **后端测试** - curl 测试 API
4. **前端开发** - 页面 → API 调用 → UI
5. **联调测试** - 完整功能测试
6. **文档更新** - API.md、DEVELOPMENT.md、README.md、开发任务.md
7. **Git 提交** - 提交代码

### 重要规则：
- ✅ 每个功能完成后立即测试
- ✅ 每次功能更新后同步更新文档
- ✅ 前后端并行开发，小功能逐个实现
- ✅ 所有文档使用中文

---

## 🎯 当前任务：功能 1 - 用户认证系统

### 任务概述
实现用户注册和登录功能，包括 JWT 认证。

### 子任务列表

#### 1.1 用户注册功能 ✅ 已完成
**后端任务：**
- [x] 创建 DTO（数据验证）
  - RegisterDto: email, password, fullName
  - LoginDto: email, password
- [x] 创建 Password Service（密码加密）
  - hashPassword()
  - verifyPassword()
- [x] 创建 JWT Service（Token 生成）
  - generateToken()
  - verifyToken()
- [x] 创建 Auth Service（业务逻辑）
  - register()
  - login()
- [x] 创建 Auth Controller（HTTP 处理）
  - POST /api/v1/auth/register
  - POST /api/v1/auth/login
- [x] 创建 Auth Routes
- [x] 注册路由到主应用

**前端任务：**
- [x] 初始化前端项目（React + TypeScript + Vite）
- [x] 配置 Ant Design UI 框架
- [x] 创建注册页面组件（Register.tsx）
- [x] 创建登录页面组件（Login.tsx）
- [x] 创建首页组件（Home.tsx）
- [x] 实现表单验证（Ant Design Form + 自定义验证规则）
- [x] 实现 API 调用服务（auth.service.ts）
- [x] 配置 Axios（请求/响应拦截器，自动 Token 管理）
- [x] 实现用户状态管理（Zustand）
- [x] 配置 React Router 路由
- [x] 实现路由跳转和登录保护

**测试结果：**
1. ✅ 使用 curl 测试注册 API - 成功
2. ✅ 验证数据库中创建了用户 - 成功
3. ✅ 测试登录 API - 成功
4. ✅ 验证返回了 JWT token - 成功
5. ✅ 前端服务器启动成功 - http://localhost:5173
6. ✅ 后端服务器运行正常 - http://localhost:3000
7. ✅ Vite 代理配置正确 - /api → backend

**文档更新：**
- [x] docs/API.md - 添加认证 API 文档
- [x] docs/DEVELOPMENT.md - 记录开发进度
- [x] docs/开发任务.md - 更新任务状态
- [x] frontend/README.md - 创建前端文档
- [x] backend/README.md - 后端文档已存在

**实际耗时：**
- 后端：约 1.5 小时
- 前端：约 2 小时
- 总计：约 3.5 小时

---

#### 1.2 权限中间件 ✅ 已完成
**后端任务：**
- [x] 创建 Auth Middleware（auth.middleware.ts）
  - requireAuth: 验证 JWT Token，提取用户信息到 req.user
  - requireAdmin: 验证用户是否为管理员
  - requireOwnerOrAdmin: 验证用户是否为资源所有者或管理员
- [x] 扩展 Express Request 类型，添加 user 属性
- [x] 实现 Token 验证和错误处理
  - 无效 Token 返回 401
  - 过期 Token 返回 401
  - 缺少 Token 返回 401

**实现细节：**
- 使用 jwt.verify() 验证 Token
- 支持三种权限级别：认证、管理员、所有者或管理员
- 统一错误响应格式

**实际耗时：** 约 0.5 小时

---

#### 1.3 用户管理 API ✅ 已完成
**后端任务：**
- [x] 创建 User Controller（user.controller.ts）
  - getAllUsers: 获取所有用户列表（分页、搜索）
  - getUserById: 获取单个用户信息
  - updateUser: 更新用户信息
  - deleteUser: 删除用户
- [x] 创建 User Routes（user.routes.ts）
  - GET /api/v1/users（管理员）
  - GET /api/v1/users/:id（本人或管理员）
  - PUT /api/v1/users/:id（本人或管理员）
  - DELETE /api/v1/users/:id（仅管理员）
- [x] 注册路由到主应用（routes.ts）
- [x] 添加认证和权限中间件

**安全特性：**
- 普通用户不能修改自己的角色
- 不能删除自己的账户
- 邮箱唯一性验证
- 使用 Zod 进行数据验证

**实际耗时：** 约 1 小时

**文档更新：**
- [x] docs/API.md - 添加用户管理 API 文档
- [x] docs/开发任务.md - 更新任务状态
- [x] Git 提交 - 提交代码

---

## 🎯 当前任务：功能 2 - KOL 管理系统

### 任务概述
实现 KOL（Key Opinion Leader）的完整管理功能，包括 CRUD 操作、批量导入、搜索筛选等。

### 子任务列表

#### 2.1 KOL 后端开发 ✅ 已完成
**架构说明：**
使用分层架构（Layered Architecture）：
- DTO 层：数据验证（Zod）
- Service 层：业务逻辑
- Controller 层：HTTP 处理
- Routes 层：路由定义

**后端任务：**
- [x] 创建 DTO 层
  - create-kol.dto.ts - 创建 KOL 验证（支持 parseTwitterUsername 函数）
  - update-kol.dto.ts - 更新 KOL 验证
  - kol-query.dto.ts - 查询参数验证（分页、筛选、排序）
- [x] 创建 Service 层（kol.service.ts）
  - createKOL() - 创建单个 KOL
  - batchImportKOLs() - 批量导入（支持 @username、username、URL）
  - getKOLList() - 分页列表（搜索、筛选、排序）
  - getKOLById() - 获取详情
  - updateKOL() - 更新信息
  - deleteKOL() - 删除 KOL
- [x] 创建 Controller 层（kol.controller.ts）
  - 所有 HTTP 端点处理
  - 错误处理和响应标准化
  - 使用 asyncHandler 统一异常处理
- [x] 创建 Routes 层（kol.routes.ts）
  - POST /api/v1/kols - 创建 KOL
  - POST /api/v1/kols/batch/import - 批量导入
  - GET /api/v1/kols - 获取列表
  - GET /api/v1/kols/:id - 获取详情
  - PUT /api/v1/kols/:id - 更新
  - DELETE /api/v1/kols/:id - 删除
  - 所有路由使用 requireAuth 中间件
- [x] 注册路由到主应用（routes.ts）
- [x] 更新 API 文档（docs/API.md）

**实现特点：**
- 用户数据隔离（所有操作自动过滤 userId）
- 智能批量导入（支持 3 种格式，自动去重）
- 完整的输入验证（Zod）
- 统一的错误处理
- 详细的日志记录

**实际耗时：** 约 3 小时

---

#### 2.2 KOL 前端开发 ⏳ 待开始
**前端任务：**
- [ ] 创建类型定义（types/kol.ts）
  - KOL 接口
  - DTO 接口
  - 枚举类型（KOLStatus、ContentCategory）
- [ ] 创建 API 服务层（services/kol.service.ts）
  - 所有 API 调用封装
- [ ] 创建状态管理（store/kol.store.ts）
  - Zustand store
  - KOL 列表状态
  - 筛选和搜索状态
- [ ] 创建复用组件
  - KOLCard.tsx - KOL 信息卡片
  - KOLTable.tsx - KOL 表格
  - KOLStatusBadge.tsx - 状态标签
  - QualityScoreBar.tsx - 质量分进度条
- [ ] 创建页面组件
  - KOLList.tsx - 列表页面（表格、分页、搜索、筛选）
  - KOLDetail.tsx - 详情页面（个人资料、联系历史）
  - KOLImport.tsx - 导入页面（批量导入）
- [ ] 配置路由
  - /kols - 列表页
  - /kols/:id - 详情页
  - /kols/import - 导入页

**UI 设计要点：**
- 使用 Ant Design 组件库
- 保持 Web3 深色主题
- 状态标签颜色：new（蓝色）、contacted（橙色）、replied（绿色）、negotiating（紫色）、cooperating（青色）、rejected（红色）、not_interested（灰色）

**预期时间：** 4.5 小时

---

#### 2.3 前后端联调 ⏳ 待开始
**测试任务：**
- [ ] 测试 KOL 列表、搜索、筛选
- [ ] 测试 KOL 创建、编辑、删除
- [ ] 测试批量导入功能
- [ ] 测试分页和排序
- [ ] 验证用户数据隔离

**预期时间：** 1 小时

---

#### 2.4 文档更新和提交 ⏳ 待开始
**文档任务：**
- [ ] 更新 docs/API.md - 添加 KOL API 文档
- [ ] 更新 docs/开发任务.md - 标记功能 2 完成
- [ ] Git 提交 - 提交代码

**预期时间：** 30 分钟

---

## 🎯 未来任务

### 功能 3 - 模板管理系统
- 创建模板
- 查看模板列表
- 编辑模板
- 删除模板
- 变量替换功能

### 功能 4 - 联系记录系统
- 记录联系历史
- 查看联系时间线
- 统计功能

### 功能 5 - 质量评分算法
- KOL 质量评分计算
- 内容分析
- 自动分类

### 功能 6 - AI 集成
- OpenAI 模板生成
- Anthropic 集成
- 内容分析

### 功能 7 - 浏览器插件
- 快速捕获 KOL
- 批量导入

---

## 📝 用户需求记录

### 2025-11-06 - 初始需求
1. **KOL 筛选规则：**
   - 粉丝数：1,000 - 50,000
   - 活跃度：7 天内有推文
   - 内容优先级：合约点位分析 > crypto 代币交易 > web3 领域
   - 语言排除：中文、土耳其语、中东地区语言、波斯语

2. **核心功能：**
   - 话术模板管理（支持 AI 生成）
   - KOL 数据库和 CRM 系统
   - KOL 发现和自动评分
   - 联系助手（复制话术，手动发送）
   - 浏览器插件辅助

3. **技术要求：**
   - 后端：TypeScript + Express + Prisma
   - 前端：React + TypeScript + Ant Design
   - 数据库：PostgreSQL / SQLite
   - 包管理器：pnpm
   - 全中文文档

4. **开发流程：**
   - 每个功能完成后立即测试
   - 同步更新文档
   - 前后端并行开发
   - 小功能逐个实现

---

## ⚠️ 注意事项

1. **安全性：**
   - 不要自动发送 DM（避免 Twitter 封号）
   - 密码必须加密存储（bcrypt）
   - JWT Secret 至少 32 个字符
   - 所有输入必须验证（Zod）

2. **代码规范：**
   - 所有代码注释使用中文
   - 遵循 ESLint 和 Prettier 规则
   - 使用 TypeScript 路径别名（@/）

3. **Git 提交：**
   - 每个功能一个 commit
   - commit message 使用中文
   - 包含详细说明

---

**最后更新：** 2025-11-06
**当前进度：**
- 功能 1 - 用户认证系统（1.1, 1.2, 1.3）已完成 ✅
- 功能 2 - KOL 管理系统（2.1）进行中 ⏳
