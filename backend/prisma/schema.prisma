// Prisma Schema for KOL-BD-Tool
// 根据 docs/DATABASE.md 设计迁移

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // 开发环境使用 SQLite，生产环境改为 "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id             Int          @id @default(autoincrement())
  email          String       @unique
  hashedPassword String
  fullName       String
  role           String       @default("member") // 'admin' 或 'member'
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // 关系
  kols           KOL[]
  templates      Template[]
  contactLogs    ContactLog[]
  tags           Tag[]
  extensionToken ExtensionToken?

  @@index([email])
}

// KOL 表
model KOL {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Twitter 资料数据
  twitterId       String?   @unique
  username        String
  displayName     String
  bio             String?
  followerCount   Int       @default(0)
  followingCount  Int       @default(0)
  verified        Boolean   @default(false)
  profileImgUrl   String?

  // 分析数据
  language        String    @default("en") // 语言：'en', 'ja', 'ko', 'fr', 'de', 'ru', 'hi'
  lastTweetDate   DateTime?
  accountCreated  DateTime?
  qualityScore    Int       @default(0) // 0-100 评分
  contentCategory String?   // 'contract_trading', 'crypto_trading', 'web3', 'unknown'

  // CRM 数据
  status          String    @default("new") // 'new', 'contacted', 'replied', 'negotiating', 'cooperating', 'rejected', 'not_interested'
  customNotes     String?

  // 时间戳
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关系
  contactLogs     ContactLog[]
  tweets          Tweet[]
  kolTags         KOLTag[]

  @@index([userId])
  @@index([status])
  @@index([qualityScore])
  @@index([followerCount])
  @@index([contentCategory])
}

// 模板表（主表 - 多语言模板容器）
model Template {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 模板数据
  name         String
  category     String   // 'initial', 'followup', 'negotiation', 'collaboration', 'maintenance'

  // 使用统计
  useCount     Int      @default(0)    // 使用次数
  successCount Int      @default(0)    // 成功响应次数

  // 时间戳
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关系
  versions     TemplateVersion[] // 多语言版本
  contactLogs  ContactLog[]

  @@index([userId])
  @@index([category])
}

// 模板语言版本表
model TemplateVersion {
  id         Int      @id @default(autoincrement())
  templateId Int
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // 语言版本数据
  language   String   // 'en', 'zh', 'ja', etc.
  content    String

  // 时间戳
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([templateId, language]) // 每个模板的每种语言只能有一个版本
  @@index([templateId])
  @@index([language])
}

// 联系记录表
model ContactLog {
  id              Int       @id @default(autoincrement())
  kolId           Int
  kol             KOL       @relation(fields: [kolId], references: [id], onDelete: Cascade)
  templateId      Int?
  template        Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 联系详情
  messageContent  String
  contactType     String    @default("dm") // 'dm', 'reply', 'email', 'other'
  status          String    @default("sent") // 'sent', 'replied', 'no_response'

  // 时间戳
  sentAt          DateTime  @default(now())
  repliedAt       DateTime?

  // 响应数据
  responseContent String?
  sentiment       String?   // 'positive', 'neutral', 'negative'
  notes           String?

  // 记录元数据
  createdAt       DateTime  @default(now())

  @@index([kolId])
  @@index([userId])
  @@index([sentAt])
}

// 推文表
model Tweet {
  id             Int      @id @default(autoincrement())
  kolId          Int
  kol            KOL      @relation(fields: [kolId], references: [id], onDelete: Cascade)

  // Twitter 数据
  tweetId        String   @unique
  content        String

  // 互动指标
  likes          Int      @default(0)
  retweets       Int      @default(0)
  replies        Int      @default(0)

  // 分析
  postedAt       DateTime
  cryptoKeywords String?  // JSON 字符串数组
  relevanceScore Int      @default(0) // 0-100 评分

  // 时间戳
  createdAt      DateTime @default(now())

  @@index([kolId])
  @@index([tweetId])
  @@index([postedAt])
}

// 标签表
model Tag {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 标签数据
  name      String
  color     String   @default("#1890ff") // 十六进制颜色代码

  // 时间戳
  createdAt DateTime @default(now())

  // 关系
  kolTags   KOLTag[]

  @@unique([userId, name]) // 每个用户的标签名称唯一
  @@index([userId])
}

// KOL-标签关联表（多对多）
model KOLTag {
  kolId     Int
  kol       KOL      @relation(fields: [kolId], references: [id], onDelete: Cascade)
  tagId     Int
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([kolId, tagId]) // 复合主键
  @@index([kolId])
  @@index([tagId])
}

// 插件 Token 表
model ExtensionToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token 数据
  token     String   @unique // 随机生成的唯一 Token
  expiresAt DateTime? // 过期时间（复制后 2 小时）
  isActive  Boolean  @default(false) // 是否已激活（复制后激活）

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
}
